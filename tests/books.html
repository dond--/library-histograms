<html>
<head>
  <script type="text/javascript" src="Tests.js"></script>
  <script type="text/javascript" src="../books.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script type="text/javascript">
  var T

  function _init(){
    T=new Tests()
    T.setOutput(document.getElementById('o'))

    var eName='graph'
    var e=document.getElementById(eName)
    var wMin=12
    var wMax=25
    var h=150

    T.test('Clear graph element',function(){
      e.appendChild(document.createTextNode('text'))
      clearGraph(eName)
      if(e.hasChildNodes())
        throw 'Element '+eName+' not empty'
    })

    T.test('Construct book object',function(){
      var b=constructBook(h)
      if(b.width<wMin||b.width>wMax)
        throw 'Book width exceeded limits: '+b.width+' (min: '+wMin+', max: '+wMax+')'
      if(b.height<2*h/3||b.height>h)
        throw 'Book height exceeded limits: '+b.height+' (min: '+(2*h/3)+', max: '+h+')'
    })

    T.test('Draw book',function(){
      clearGraph(eName)
      var b=constructBook(h)
      var g=d3.select('#graph').append('svg:svg').attr('width',h).attr('height',h)
      drawBook(b,0,0,g)
      if(!e.hasChildNodes())
        throw 'Element '+eName+' empty'
      var svg=e.childNodes[0]
      if(!svg.hasChildNodes()||svg.nodeName.toLowerCase()!=='svg')
        throw 'SVG sketch not present'
      var html=svg.innerHTML.toLowerCase()
      if(html.indexOf('<rect')==-1||html.indexOf('<line')==-1)
        throw 'Rectangle and/or line missing in sketch'
    })

    T.test('Draw tilted book',function(){
      clearGraph(eName)
      var b=constructBook(h)
      var g=d3.select('#graph').append('svg:svg').attr('width',h).attr('height',h+50)
      drawBook(b,10,10,g,-13,false)// effectively same as drawLastBook()
      var svg=e.childNodes[0]
      var html=svg.innerHTML.toLowerCase()
      if(html.indexOf('translate(0,3')==-1||html.indexOf('rotate(-13')==-1)
        throw 'Tilt transformation missing in sketch'
      while(svg.hasChildNodes())// erase first drawn book
        svg.removeChild(svg.childNodes[0])
      drawBook(b,10,10,g,-21,true)
      var svg=e.childNodes[0]
      var html=svg.innerHTML.toLowerCase()
      if(html.indexOf('translate(-3,3')==-1||html.indexOf('rotate(-21')==-1)
        throw 'Kerning missing in transformed sketch'
    })

    T.test('Complete graph',function(){
      clearGraph(eName)
      for(var i=1;i<4;i++){// create fake input values
        var inp=document.createElement('input')
        inp.setAttribute('id','test-'+i+'-height')
        inp.setAttribute('value',Math.floor(Math.random()*150+25))
        document.getElementById('form').appendChild(inp)
        inp=document.createElement('input')
        inp.setAttribute('id','test-'+i+'-width')
        inp.setAttribute('value',Math.floor(Math.random()*950+25))
        document.getElementById('form').appendChild(inp)
      }
      createGraph()
      var svg=e.childNodes[0]
      if(!svg||!svg.hasChildNodes()||svg.nodeName.toLowerCase()!=='svg')
        throw 'Complete graph missing'
      var rs=svg.getElementsByTagName('rect')
      var ls=svg.getElementsByTagName('line')
      if(rs.length<1||ls.length<1)
        throw 'Book sketches missing in graph: rectangles = '+rs.length+', lines = '+ls.length
      var html=svg.innerHTML.toLowerCase()
      if(html.indexOf('translate(')==-1||html.indexOf('rotate(-13')==-1)
        throw 'Tilt transformation of last book missing in graph'
    })

    T.stat()
  }
  </script>
</head>
<body onload="_init()">
<h1>../books.js tests:</h1>
<p width="100%" height="100%" id="o" style="border:solid 1px grey"></p>
<div id="graph" style="display:none"></div>
<div id="form" style="display:none"></div>
</body>
</html>
